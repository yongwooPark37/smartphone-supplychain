# 공급망 최적화 모델 요약 보고서 (SmartPhone Global Supply-Chain Challenge)
## 1단계 (Phase 1)

탐색적 데이터 분석(EDA) 기반의 피처 엔지니어링과 이종 모델을 결합한 앙상블 기법을 활용하여 2023년부터 2024년까지의 일별 · SKU별 · 도시별 수요를 정밀하게 예측



## 2단계 (Phase 2)

공급망 최적화는 생산, 재고, 운송 등 다양한 제약조건을 만족시키면서 비용을 최소화하기 위해 Chunked Rolling Horizon MILP를 통해 결과 도출



---



# Phase 1



## 1. 알고리즘 채택 배경 및 모델 설계 과정

본 프로젝트의 수요 예측(Phase 1) 단계는 복잡한 앙상블 모델의 과적합 문제를 해결하기 위해 **단순화된 Random Forest 기반 접근법**을 채택했습니다. 초기 복잡한 모델이 공식 베이스라인(RMSE 302.26)보다 성능이 저하되는 문제를 겪었으며, 이를 통해 "더 많은 피처와 복잡한 모델 = 더 나은 성능"이라는 일반적 믿음이 항상 옳지 않다는 중요한 인사이트를 얻었습니다.

### 핵심 설계 철학: "단순함의 힘"

* **과적합 방지**: 복잡한 앙상블 모델 대신 단일 Random Forest 모델을 사용하여 과적합을 방지하고 일반화 성능을 향상시켰습니다.

* **핵심 피처 중심**: 20개 이상의 복잡한 피처 대신 12개의 핵심 피처만 선별하여 모델의 해석 가능성을 높이고 학습 속도를 개선했습니다.

* **실용적 이벤트 처리**: 복잡한 Z-score 기반 동적 이벤트 탐지 대신, 과거 데이터 분석을 통해 도출된 **실제 이벤트 패턴**을 하드코딩하여 안정적인 예측을 보장했습니다.

### 모델 단순화의 배경

초기 실험에서 복잡한 앙상블 모델(Random Forest + Gradient Boosting + Linear Regression)이 RMSE 321.2를 기록하여 공식 베이스라인보다 성능이 저하되었습니다. 이는 다음과 같은 문제들 때문이었습니다:

* **피처 과부하**: 50개 이상의 피처로 인한 차원의 저주(Dimensionality Curse)
* **앙상블 복잡성**: 여러 모델의 예측을 결합하는 과정에서 발생하는 오차 누적
* **과적합**: 복잡한 모델이 훈련 데이터의 노이즈까지 학습

이러한 경험을 바탕으로 **"단순하지만 효과적인"** 모델 설계 원칙을 채택했습니다.



### 2.2 주요 예측 변수(피처) 설계

단순화된 모델은 **핵심적이고 해석 가능한 피처**만을 선별하여 사용합니다. 복잡한 외부 요인(유가, 환율, 날씨 등)을 제거하고 수요 예측에 직접적으로 영향을 미치는 핵심 변수들에 집중했습니다.

#### 핵심 피처 구성 (총 12개)

* **시간 기반 변수 (3개)**: `month`, `weekday`, `dayofyear` - 계절성과 주기성 패턴 포착
* **제품 특성 변수 (2개)**: `days_since_launch`, `storage_gb` - 제품 수명주기와 사양 반영
* **시계열 변수 (2개)**: `demand_lag_7`, `demand_lag_30` - 단기/장기 수요 패턴 학습
* **집계 변수 (2개)**: `city_avg_demand`, `sku_avg_demand` - 지역별/제품별 기준 수요
* **범주형 변수 (3개)**: `city`, `sku`, `country`, `family` (Label Encoding 적용)

#### 피처 선택의 철학

* **해석 가능성**: 각 피처가 수요에 미치는 영향이 명확하게 해석 가능
* **안정성**: 외부 데이터의 불확실성을 배제하고 내부 데이터의 일관성 보장
* **효율성**: 최소한의 피처로 최대한의 예측 성능 달성

#### 제거된 복잡한 피처들

* **외부 요인**: 유가, 환율, 소비자신뢰지수, 날씨 데이터
* **복잡한 시계열 피처**: Rolling Standard Deviation, 변동성 지표
* **고차원 변환**: Sin/Cos 변환, PCA 요인
* **동적 이벤트 탐지**: Z-score 기반 실시간 이벤트 감지

### 2.3 신제품 공개 행사 처리 방식

신제품 공개 행사는 수요 예측에서 가장 중요한 요소 중 하나로, 본 모델에서는 **실용적이고 안정적인 접근법**을 채택했습니다.

#### 이벤트 탐지 및 배수 적용

**1. 하드코딩된 이벤트 패턴**
과거 데이터 분석을 통해 도출된 실제 이벤트 패턴을 직접 모델에 반영:

```python
2023년 이벤트:
- CAN (캐나다): 2023-09-01 ~ 2023-11-30 (3개월), 배수 2.57
- DEU (독일): 2023-11-01 ~ 2023-12-31 (2개월), 배수 2.30  
- BRA (브라질): 2023-10-01 ~ 2023-12-31 (3개월), 배수 2.34

2024년 이벤트:
- DEU (독일): 2024-07-01 ~ 2024-09-30 (3개월), 배수 2.30
- JPN (일본): 2024-07-01 ~ 2024-09-30 (3개월), 배수 2.21
- GBR (영국): 2024-07-01 ~ 2024-09-30 (3개월), 배수 2.39
```

**2. 예측 과정에서의 적용**
1. **기본 예측**: Random Forest 모델로 일반적인 수요 패턴 예측
2. **이벤트 배수 적용**: 해당 국가의 이벤트 기간에 배수 적용
3. **최종 예측**: `최종 수요 = 기본 예측 × 이벤트 배수`

**3. 적용 방식의 장점**
* **안정성**: 동적 탐지의 불확실성 제거
* **예측 가능성**: 명확한 이벤트 기간과 배수
* **실용성**: 복잡한 알고리즘 없이도 효과적 처리
* **해석 가능성**: 각 국가별 이벤트 영향 명확히 파악

#### 이벤트 처리의 핵심 철학

복잡한 Z-score 기반 동적 탐지 대신, **"과거 데이터에서 발견된 패턴을 미래에 적용"**하는 보수적이지만 신뢰할 수 있는 접근법을 선택했습니다. 이는 다음과 같은 이유 때문입니다:

* **데이터 기반**: 실제 과거 이벤트 데이터 분석 결과 활용
* **비즈니스 로직 반영**: 신제품 공개 행사의 계절성과 지역성 고려
* **위험 최소화**: 예측 불가능한 동적 탐지보다 안정적인 패턴 적용



### 2.4 수요 예측 모델 비교 분석

본 프로젝트에서 채택한 **단순화된 Random Forest 접근법**은 다양한 모델링 전략을 실험한 결과 도출된 최적의 해결책입니다.

#### 실험된 모델들과의 비교

* **복잡한 앙상블 모델 (Random Forest + Gradient Boosting + Linear Regression)**: RMSE 321.2로 공식 베이스라인(302.26)보다 성능 저하. 과적합과 피처 과부하로 인한 문제 발생.

* **다양한 단일 모델 비교**:
  - Linear Regression: RMSE 302.35 (베이스라인과 유사)
  - Random Forest (단순화): RMSE 309.34 (적절한 성능)
  - XGBoost/LightGBM: 일정 기간 동안 동일한 예측값 생성 (학습 문제)

* **전통적 시계열 모델 (ARIMA, SARIMA)**: 다변량 예측과 외부 요인 반영에 한계가 있어 본 프로젝트의 복잡한 수요 패턴에는 부적합.

#### 최종 선택: 단순화된 Random Forest

**선택 이유**:
* **안정성**: 일관된 예측 성능과 해석 가능성
* **효율성**: 빠른 학습과 예측 속도
* **실용성**: 복잡한 하이퍼파라미터 튜닝 불필요
* **확장성**: 새로운 피처 추가가 용이


---



# Phase 2



## 1. 목적식

목표:  

USD 기준 총비용 + 환경부담금 최소화  



총비용 구성:

- 생산비용

- 운송비용

- 재고 보관비용

- 부족 패널티

- 설비 건설비

- 운송 모드 변경 수수료



---



## 2. 제약식 요약



### 2-1. 서비스 수준

- Fill-Rate 95% 이상 유지



### 2-2. 시설

- 공장 최대 5곳, 창고 최대 20곳

- 동일 도시에 공장·창고 각각 1곳만 설치 가능

- 공장에는 재고 불가

- 공장: 착공 다음 월요일 00시부터 가동, 폐쇄 불가

- 창고: 착공 즉시 완공

- 초기 상태: 모든 창고-SKU 재고 2,000 unit



### 2-3. 생산

- 주별 정규·초과 근무 한도 초과 불가

- SKU별 노동시간 × 생산량 ≤ 주당 최대 근로시간

- 1일 8시간 초과 생산분 → 초과근무 임금 적용

- 기계 고장 기간 중 해당 공장 모든 작업 정지



### 2-4. 재고·유효기간

- 해당 도시에 창고가 있으면 운송비용 없이 수요 소화

- 유효기간(life_days) 경과 재고는 반드시 폐기



### 2-5. 운송

- 허용 경로: 공장→창고, 창고→도시 (창고→창고 불가)

- 동일 국가: 트럭만 허용

- 국가 간: 배 또는 비행기

- 컨테이너 용량: 4,000 unit (부분 적재 허용, 비용 1컨테이너 기준)

- 1회 운송에 복수 모드 혼합 불가

- 국경 통과: 4,000 USD (DEU↔FRA 면제)

- 악천후 시 운송비 ×3 (출발 당일 기준)

- 유가 전주 대비 +5% 이상 상승 시 해당 주 운송비 ×2

- "구간-요일-모드" 4주 고정, 변경 시 직전 4주 운송비의 5% 수수료

- 동일 구간·요일에 모드 분할 운송 금지



### 2-6. 환경부담금

- 생산 CO₂ = carbon_factor_prod × 생산량

- 운송 CO₂ = 거리 × 모드별 CO₂계수 × 컨테이너 수

- 합산 후 200 USD/ton 부과  

  (올림 계산, 1ton 미만도 1ton 적용)



---



## 3. 구현 방식



### Chunked Rolling Horizon MILP
공급망 최적화는 생산, 재고, 운송 등 다양한 제약조건을 만족시키면서 비용을 최소화해야 하는 복잡한 문제로, 혼합 정수 선형 계획법(MILP)을 기반으로 설계
특히, 모든 변수를 그대로 사용하는 순수 MILP 모델로는 해결 불가능하기 때문에 방대한 시공간적 범위와 다양한 제약조건을 모두 고려하면 모델의 복잡도가 기하급수적으로 증가하여 현실적인 시간 내에 해를 구하기 어려움. 이러한 문제를 해결하기 위해, 전체 기간을 작은 단위(chunk)로 나누어 순차적으로 최적화하는 Chunked Rolling Horizon 기법을 채택. 
1. 기간 분할 (31일 단위)  

   - 전체 기간을 최대 31일(약 1개월) 길이의 청크(chunk)로 나눔  

   - 각 청크별로 날짜·SKU·도시별 생산·운송·재고 의사결정 수행  

   - 청크 간 연속성 유지를 위해 다음 데이터 전달:

     1. 이전 청크 종료 시점 재고 (창고-SKU별)

     2. 이전 청크에서 출발했으나 도착하지 않은 운송 물량 (리드타임 반영)



2. 순차 최적화

   - 각 청크는 독립적으로 풀지만, 초기 상태를 이어받아 전 기간 연속성 확보

   - Fill-Rate, 생산·운송·재고 제약 유지

   - 계산 복잡도 O(N×기간) → O(N×청크)로 축소



---



## 4. 문제 축소·간소화 기법



### 4-1. Arc Pruning (네트워크 축소)



필요성  

- 공장 후보지 × 창고 후보지 + 창고 후보지 × 도시 수  

- 각 날짜 × 운송 모드 × SKU 조합까지 고려 시 변수(Y, Q) 기하급수적 증가  

- 예: 80개 도시(공장·창고 후보) × 40개 도시(수요지) × 3모드 × 2년치 날짜 = 수백만 Arc  

→ 변수·제약 수 과도 → 연산 불가능



핵심 아이디어  

- 선택 가능성이 낮은 비효율 Arc를 사전 제거  

- 본 구현은 On-the-fly Filtering 방식 적용:

  - 모든 Arc를 미리 만들고 제거하는 대신, 모델 빌드 시 조건을 만족하지 않는 Arc는 생성하지 않음



필터 조건

1. 리드타임 기반  

   - Arc 출발일 + 리드타임이 청크 내 도착일 범위에 없으면 제외

2. 유통기한 기반  

   - 도착 시점이 SKU의 유효 기간 초과 시 제외

3. 네트워크 연결성 기반  

   - (i,k) in IK 또는 (k,j) in KJ 조건만 허용  

   - 창고→창고, 금지 모드 등은 생성 안 함



---



### 4-2. 제약 완화

- Fill-Rate → 주간 합 기준 + Slack (패널티 부과)

- 일부 이진 제약 (예: 모드 변경) → Relaxation 처리